# Safari RCE CVE-2020-9802

## Vulnerability Overview

Out of bounds read/write in the JIT compiler of WebKit. During an optimization phase of the JIT compiler, an integer overflow can occur in the `ArithNegate` operation. When attempting to make an integer of size `INT_MIN (-2147483648)` negative, the integer (`-INT_MIN`) overflows and results as `INT_MIN` again. This improper calculation allows for the ability to create an "unchecked `ArithNegate` operation" where the JIT compiler removes overflow checks on the integer value as the JIT compiler thinks that the integer value always results in a negative number. It is possible to use the "unchecked `ArithNegate`operation" integer as a indexing value for arrays, causing an out of bounds read/write condition.

```
 case ArithNegate:
        if (node->child1().useKind() == Int32Use || ...)
            def(PureValue(node));          // <- only the input matters, not the ArithMode
```
```
v = ArithNeg(unchecked) n
i = v
```
## Exploit Overview

This exploit chain uses a vulnerability inside of the JIT compiler of Safari (WebKit) to achieve an arbitrary read/write primitive inside of rendering engine of WebKit (Safari Web Content) on macOS. Using this read/write primitive, SOP, X-FRAME-OPTIONS and service worker validation protections are disabled within the Safari rendering engine to achieve UXSS and the ability to install an arbitrary service worker for `cvws.icloud-content.com`. 

When a user uploads a file to iCloud Drive, that file is later indexed using the domain of `cvws.icloud-content.com`. By uploading a service worker (`.txt`) to iCloud Drive and then using a UXSS to install it using the indexed URL off of `cvws.icloud-content.com`, it is possible to modify and intercept all web traffic to `cvws.icloud-content.com` when a user attempts to retrieve files from iCloud Drive using Safari. This makes it possible to inject new content when a user views files on iCloud Drive and even the ability to redirect and hijack downloads.

Because service workers are persistent, the exploit will remain inside of Safari even if the Safari is closed, quit or if the system is restarted.

## Exploit Steps
1. Achieve out of bounds read/write on target array 
2. Corrupt the target array's length to `0x1337`
3. Construct `addrof()` primitive 
4. Construct `fakeobj()` primitive
5. Create fake `JSCell` header
6. Set up fake `JSObject`
7. Set up fake `JSArray`
8. Leak real `JSCell` Structure ID
9. Copy real Structure ID to fake `JSObject`
10. Achieve limited read/write by abusing the fake `JSObject`'s `Butterfly`
11. Bypass Gigacage by causing an uncaged pointer to leak onto the stack
12. Bypass SOP by overwriting `m_universalAccess` of the `SecurityOrigin`
13. Bypass X-FRAME-OPTIONS by overwriting the `m_data.host` of `SecurityOrigin`
14. Create `serviceWorker` object
15. Retrieve VTABLE pointer to `ServiceWorkerJob::didReceiveResponse`
16. Create RWX JIT memory
17. Write `NOP` sled + `ret` into RWX JIT memory
18. Overwrite VTABLE pointer to `ServiceWorkerJob::didReceiveResponse` with address to JIT RWX memory
19. Preform UXSS on `https://cvws.icloud-content.com`
20. Install service worker located on `https://cvws.icloud-content.com` 

## Exploit Demo
[![](http://img.youtube.com/vi/S5NUdYlIh5c/0.jpg)](http://www.youtube.com/watch?v=S5NUdYlIh5c "CVE-2020-9802 Demo")

## References

* https://googleprojectzero.blogspot.com/2020/09/jitsploitation-one.html?m=1
* https://googleprojectzero.blogspot.com/2020/09/jitsploitation-two.html?m=1
* https://msrnd-cdn-stor.azureedge.net/bluehat/bluehatil/2019/assets/doc/Forget%20the%20Sandbox%20Escape%20Abusing%20Browsers%20from%20Code%20Execution.pdf

## Shout Outs
*  Samuel GroÃŸ, Project Zero (@5aelo)
*  Amy Burnett, Ret2Systems (@itszn13)